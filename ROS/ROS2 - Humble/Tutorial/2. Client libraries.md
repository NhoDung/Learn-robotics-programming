> [!info] `colcon` : Là bản cải tiến của ROS2 build tools như `catkin_make`, `catkin_make_isolated`, `catkin_tool`

> [!important] Khi source ros2 enviroment đã có kèm theo rất nhiều example packages, vì thế không nên tạo thêm package có tên giống, nếu không sẽ gây ra crash chương trình

## 1. Basic skills

> [!summary] Cần nắm được:
> - Cách tạo new workspace
> - Cách tạo basic package
> - Cách build workspace and packages
> - Cách tạo package with dependencies

> [!summary] Để tạo ROS2 package ta dùng cmd `ros2 pkg create` với các tham số:
> - `--build-type <build_type>` : Lựa chọn build type như `ament_cmake` hoặc `ament_python`
> - `--node-name <node_name>` : Đặt tên node muốn tạo khi tạo package
> - `--dependencies <dependency1> <dependency2> <dependency3> ...` : Add các dependencies cần thiết
> - `--license`, `--description`, ... : Các tham số khai báo thông tin của package

> [!question] Problem: [[Build một workspace có sẵn]]

> [!question] Problem: [[Tạo workspace với package có một node cơ bản. Sau đó build và run node đó.]]


> [!question] Problem: [[Tạo workspace và clone package và sau đó build + run node để test]]


## 2. Write publisher and subcriber

> [!info] Các thư viện có thể dùng sẵn với ROS2 được lưu ở:
> - `/opt/ros/humble/include/` : Các thư viện cho C++
> 	- `rclcpp` : Cung cấp các API cần thiết để xây dựng các node, giao tiếp các node và tạo các pub, sub, service, action, client, ...
> 	- `std_msgs` : Cung cấp các built-in message
> - `/opt/ros/humble/local/lib/python3.10/dist-packages/` : Các thư viện cho Python
> 	- `rclpy` : Tương tự với `rclcpp` nhưng là cho Python
> 	- `std_msgs` : Cung cấp các built-in message
> 	- `std_srvs` : Cung cấp các built-in service


> [!question] Problem: [[Tạo và config pub-sub nodes có sẵn bằng C++]]

> [!error] Khi thêm các thư viện của ROS2 C++ vào sẽ báo lỗi `Include path` trong editor VS code ? [[Fix include path]]

> [!question] Problem: [[Tạo và config pub-sub nodes có sẵn bằng Python]]
## 3. Write service and client

## 4. Example: Writing a simple service and client by C++
- **Task 1:** Create package
```bash
	# Create workspace

	# Create package
	ros2 pkg create --build-type ament_cmake --license Apache-2.0 cpp_srvcli --dependencies rclcpp example_interfaces # Tham số dependencies khai báo các gói phụ thuộc để không mất công chỉnh sửa nhiều liên quan package.xml và CMakeList.txt
``` 
> Note: Package `example_interfaces` đã định nghĩa sẵn service file
- **Task 2:** Download code for simple service and client
```cpp
	// Service node
	#include "rclcpp/rclcpp.hpp"
	#include "example_interfaces/srv/add_two_ints.hpp"
	
	#include <memory>
	
	void add(const std::shared_ptr<example_interfaces::srv::AddTwoInts::Request> request,
	          std::shared_ptr<example_interfaces::srv::AddTwoInts::Response>      response)
	{
	  response->sum = request->a + request->b;
	  RCLCPP_INFO(rclcpp::get_logger("rclcpp"), "Incoming request\na: %ld" " b: %ld",
	                request->a, request->b);
	  RCLCPP_INFO(rclcpp::get_logger("rclcpp"), "sending back response: [%ld]", (long int)response->sum);
	}
	
	int main(int argc, char **argv)
	{
	  rclcpp::init(argc, argv);
	
	  std::shared_ptr<rclcpp::Node> node = rclcpp::Node::make_shared("add_two_ints_server");
	
	  rclcpp::Service<example_interfaces::srv::AddTwoInts>::SharedPtr service =
	    node->create_service<example_interfaces::srv::AddTwoInts>("add_two_ints", &add);
	
	  RCLCPP_INFO(rclcpp::get_logger("rclcpp"), "Ready to add two ints.");
	
	  rclcpp::spin(node);
	  rclcpp::shutdown();
	}
```

```cpp
	// Client node
	#include "rclcpp/rclcpp.hpp"
	#include "example_interfaces/srv/add_two_ints.hpp"
	
	#include <chrono>
	#include <cstdlib>
	#include <memory>
	
	using namespace std::chrono_literals;
	
	int main(int argc, char **argv)
	{
	  rclcpp::init(argc, argv);
	
	  if (argc != 3) {
	      RCLCPP_INFO(rclcpp::get_logger("rclcpp"), "usage: add_two_ints_client X Y");
	      return 1;
	  }
	
	  std::shared_ptr<rclcpp::Node> node = rclcpp::Node::make_shared("add_two_ints_client");
	  rclcpp::Client<example_interfaces::srv::AddTwoInts>::SharedPtr client =
	    node->create_client<example_interfaces::srv::AddTwoInts>("add_two_ints");
	
	  auto request = std::make_shared<example_interfaces::srv::AddTwoInts::Request>();
	  request->a = atoll(argv[1]);
	  request->b = atoll(argv[2]);
	
	  while (!client->wait_for_service(1s)) {
	    if (!rclcpp::ok()) {
	      RCLCPP_ERROR(rclcpp::get_logger("rclcpp"), "Interrupted while waiting for the service. Exiting.");
	      return 0;
	    }
	    RCLCPP_INFO(rclcpp::get_logger("rclcpp"), "service not available, waiting again...");
	  }
	
	  auto result = client->async_send_request(request);
	  // Wait for the result.
	  if (rclcpp::spin_until_future_complete(node, result) ==
	    rclcpp::FutureReturnCode::SUCCESS)
	  {
	    RCLCPP_INFO(rclcpp::get_logger("rclcpp"), "Sum: %ld", result.get()->sum);
	  } else {
	    RCLCPP_ERROR(rclcpp::get_logger("rclcpp"), "Failed to call service add_two_ints");
	  }
	
	  rclcpp::shutdown();
	  return 0;
	}
```
- **Task 3:** Add executable
```txt
	add_executable(server src/add_two_ints_server.cpp)
	ament_target_dependencies(server rclcpp example_interfaces)
	
	add_executable(client src/add_two_ints_client.cpp)
	ament_target_dependencies(client rclcpp example_interfaces)
	
	install(TARGETS
	  server
	  client
	  DESTINATION lib/${PROJECT_NAME})
```
- **Task 4:** Build package and run workspace
```bash
	colcon build --packages-select cpp_srvcli

	# Terminal 1: Run service node
	ros2 run cpp_srvcli server

	# Terminal 2: Run client node with parameters
	ros2 run cpp_srvcli client 2 3
```

## 5. Example: Creating custom msg and srv file
- **Task 1:** Create package & Custom `.msg` and `.srv` files
```bash
	ros2 pkg create --build-type ament_cmake --license Apache-2.0 tutorial_interfaces

	# Create folder containing .msg and .srv file
	mkdir msg srv
```
- **Task 2:** Definition `.msg` and `.srv` file
```txt
	# Num.msg file
	int64 num

	# Sphere.msg file
	geometry_msgs/Point center
	float64 radius

	# AddThreeInts.srv file
	int64 a
	int64 b
	int64 c
	---
	int64 sum
```
- Để convert interfaces tự định nghĩa sang ngôn ngữ lập trình như C++ hay Python (Để sử dụng trong những ngôn ngữ này) thì thêm dòng sau vào `CMakeLists.txt`
```txt
	find_package(geometry_msgs REQUIRED)
	find_package(rosidl_default_generators REQUIRED)

	rosidl_generate_interfaces(${PROJECT_NAME}
	  "msg/Num.msg"
	  "msg/Sphere.msg"
	  "srv/AddThreeInts.srv"
	  DEPENDENCIES geometry_msgs # Add packages that above messages depend on, in this case geometry_msgs for Sphere.msg
	)
```
> Note: IDL - Interface Definition Language
- Vì các interface nhờ vào `rosidl_default_generators` để generating to code -> Cần declare 1 build tool dependency trên nó. Add following lines within `<package>` element
```xml
	<depend>geometry_msgs</depend>
	<buildtool_depend>rosidl_default_generators</buildtool_depend>
	<exec_depend>rosidl_default_runtime</exec_depend>
	<member_of_group>rosidl_interface_packages</member_of_group>
```
### 5.1. Option 1: Test with no source code
- Build workspace and source environment
- Confirm interface creation worked by using command `ros2 interface show`
```bash
	# Check msgs
	ros2 interface show tutorial_interfaces/msg/Num

	# Check srv
	ros2 interface show tutorial_interfaces/srv/AddThreeInts
```
### 5.2. Option 2: Test message with pub/sub


### 5.3. Option 3: Test service with srv/cli
## 6. Example: Implementing custom interfaces

## 7. Example: Using parameter in a class by C++

## 8. Example: Creating and using plugins by C++
- `pluginlib` : A C++ library for loading and unloading plugins from within a ROS package
- Plugin: Dynamically loadable classes (Các lớp có thể load tự động) và được load from a runtime library
- Pluginlib có thể open a library chứa exported classes bất kỳ lúc nào mà không cần biết trước về library hay header file chứa class definition
- Plugin rất hữu dụng để mở rộng hoặc thay đổi application behavior mà không cần biết application source code

### 8.1. Create base class package
- Create `polygon_base` package
```bash
	ros2 pkg create --build-type ament_cmake --dependencies pluginlib --node-name area_node polygon_base
```
- Create header file
- Config `CMakeLists.txt` by adding:
```txt
	# after ament_target_dependencies
	install(
	  DIRECTORY include/
	  DESTINATION include
	)

	# before ament_package
	ament_export_include_directories(
	  include
	)
```
### 8.2. Create plugin package
- Create `polygon_plugins` package
```bash
	ros2 pkg create --build-type ament_cmake --dependencies polygon_base pluginlib --library-name polygon_plugins polygon_plugins
```
- Create plugin source code
- Plugin declaration XML -> CMake plugin declaration
- Back to area_node to use plugin
- Build and run area_node

> [!question] Problem 4: Reuse service definition to write server/client service by C++ ?

> [!question] Problem 5: Reuse service definition to write server/client service by Python ?

> [!question] Problem : Create custom interface like topic and service ?

> [!question] Problem : Implement custom interface ?

> [!question] Problem : Create and using plugin by C++ ?